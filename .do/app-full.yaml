# Full DigitalOcean app spec: web at /, backend at /project-inside-backend.
# Ingress component names must match component names (service: project-inside-backend, static_sites: web).

alerts:
  - rule: DEPLOYMENT_FAILED
  - rule: DOMAIN_FAILED

static_sites:
  - name: web
    environment_slug: node-js
    github:
      repo: jiqin822/project_inside
      branch: main
      deploy_on_push: true
    source_dir: mobile
    build_command: npm run build
    output_dir: dist
    index_document: index.html
    catchall_document: index.html
    # Do NOT add "routes" here when using ingress - routing is defined only in ingress.rules
    envs:
      - key: VITE_API_BASE_URL
        scope: BUILD_TIME
        value: https://project-inside-c6bdb.ondigitalocean.app/project-inside-backend

databases:
  - cluster_name: app-06668ad3-1709-4f0d-b4b0-2842a1044449
    db_name: dev-db-193637
    db_user: dev-db-193637
    engine: PG
    name: dev-db-193637
    production: true
    version: "17"

envs:
  - key: VITE_API_BASE_URL
    scope: RUN_AND_BUILD_TIME
    value: https://project-inside-c6bdb.ondigitalocean.app:8080

features:
  - buildpack-stack=ubuntu-22

# Web at / (root), backend at /project-inside-backend. Backend rule first (more specific).
ingress:
  rules:
    - component:
        name: project-inside-backend
      match:
        path:
          prefix: /project-inside-backend
    - component:
        name: web
      match:
        path:
          prefix: /

name: project-inside
region: nyc

services:
  - name: project-inside-backend
    environment_slug: python
    source_dir: backend
    # Slim deps for DO export disk; no torch/SpeechBrain/NeMo (app runs with those features disabled).
    build_command: pip install -r requirements-do.txt
    run_command: uvicorn app.main:app --host 0.0.0.0 --port 8080
    http_port: 8080
    instance_count: 1
    instance_size_slug: apps-s-1vcpu-2gb
    github:
      branch: main
      deploy_on_push: true
      repo: jiqin822/project_inside
    envs:
      - key: APP_NAME
        scope: RUN_AND_BUILD_TIME
        value: Project Inside API
      - key: APP_VERSION
        scope: RUN_AND_BUILD_TIME
        value: "0.1.0"
      - key: DEBUG
        scope: RUN_AND_BUILD_TIME
        value: "false"
      - key: DATABASE_ECHO
        scope: RUN_AND_BUILD_TIME
        value: "false"
      - key: ALGORITHM
        scope: RUN_AND_BUILD_TIME
        value: HS256
      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        scope: RUN_AND_BUILD_TIME
        value: "15"
      - key: REFRESH_TOKEN_EXPIRE_DAYS
        scope: RUN_AND_BUILD_TIME
        value: "30"
      - key: WEBSOCKET_HEARTBEAT_INTERVAL
        scope: RUN_AND_BUILD_TIME
        value: "30"
      - key: WEBSOCKET_TIMEOUT
        scope: RUN_AND_BUILD_TIME
        value: "60"
      - key: NUDGE_RATE_LIMIT_SECONDS
        scope: RUN_AND_BUILD_TIME
        value: "10"
      - key: SPEAKING_RATE_THRESHOLD
        scope: RUN_AND_BUILD_TIME
        value: "3.0"
      - key: OVERLAP_RATIO_THRESHOLD
        scope: RUN_AND_BUILD_TIME
        value: "0.3"
      - key: VOICEPRINT_API_TOKEN
        scope: RUN_AND_BUILD_TIME
        value: 1788124e-a63c-4140-8f69-dca50d5a4cb1
      - key: SR_THRESHOLD
        scope: RUN_AND_BUILD_TIME
        value: "2.0"
      - key: OR_THRESHOLD
        scope: RUN_AND_BUILD_TIME
        value: "0.25"
      - key: STORE_FRAMES
        scope: RUN_AND_BUILD_TIME
        value: "false"
      - key: EMAIL_BLOCKED_DOMAINS
        scope: RUN_AND_BUILD_TIME
      - key: SENDGRID_API_KEY
        scope: RUN_AND_BUILD_TIME
        value: ""
      - key: EMAIL_FROM_ADDRESS
        scope: RUN_AND_BUILD_TIME
        value: invite@seerbyse.ai
      - key: EMAIL_FROM_NAME
        scope: RUN_AND_BUILD_TIME
        value: 'Project: Inside'
      - key: STT_RECOGNIZER
        scope: RUN_AND_BUILD_TIME
        value: "projects/YOUR_GCP_PROJECT/locations/us/recognizers/your_recognizer"
      - key: STT_SPEAKER_MATCH_THRESHOLD
        scope: RUN_AND_BUILD_TIME
        value: "0.75"
      - key: STT_AUDIO_BUFFER_SECONDS
        scope: RUN_AND_BUILD_TIME
        value: "30"
      - key: STT_ESCALATION_COOLDOWN_SECONDS
        scope: RUN_AND_BUILD_TIME
        value: "5"
      - key: GEMINI_API_KEY
        scope: RUN_AND_BUILD_TIME
        value: ""
      - key: OPENAI_API_KEY
        scope: RUN_AND_BUILD_TIME
        value: ""
      - key: CORS_ORIGINS
        scope: RUN_TIME
        value: '["https://project-inside.seerbyse.ai", "https://project-inside-c6bdb.ondigitalocean.app",
          "capacitor://localhost", "ionic://localhost", "http://localhost:5173", "http://localhost:3000"]'
      - key: DATABASE_URL
        scope: RUN_TIME
        value: ""
      - key: DATABASE_SSL_VERIFY
        scope: RUN_AND_BUILD_TIME
        value: "false"
      - key: GOOGLE_APPLICATION_CREDENTIALS_JSON
        scope: RUN_AND_BUILD_TIME
        value: ""
